#!/usr/bin/Rscript --vanilla

if(!suppressPackageStartupMessages(require("docopt"))){
  stop("You must have the docopt R package installed. Assuming you have 
             installed R & Bioconductor (www.bioconductor.org/install), type:\n
             BiocInstaller::biocLite(\"docopt\") \n
             from your R prompt.")
}

doc <- "curatedMetagenomicData - command-line access to the curatedMetagenomicData R/Bioconductor package

Usage: curatedMetagenomicData [--dataset NAME] [--pdata] [--counts]

DESCRIPTION

-h --help    Show this. Note that arguments may optionally be quoted.
-d --dataset Comma-separated list of names of one or more curatedMetagenomicData datasets to return (see manual for list of all datasets)
-p --pdata   Include phenotype data in the first rows of the tsv file
-c --counts  If this flag is set, multiplied MetaPhlAn2 and HUMAnN2 relative abundances by read depth, then round to the nearest integer. If it is not set, return MetaPhlAn2 and HUMAnN2 results as-is

The script will produce one tab-separated tsv file per dataset requested. 
For each dataset requested, an output tab-separated values file will be created. 
The output files are the name of the dataset name with '.tsv' appended to it.

With -p TRUE, the first rows of the output tab-separated file will provide 
phenotype data.

EXAMPLES

curatedMetagenomicData -d LomanNJ_2013_Hi.metaphlan_bugs_list.stool -p -c

will produce a file LomanNJ_2013_Hi.metaphlan_bugs_list.stool.tsv providing MetaPhlAn2 taxonomic abundance multiplied by read depth, with metadata about study participants and sequencing information in the first several rows of the file.

curatedMetagenomicData -d LomanNJ_2013_Hi.metaphlan_bugs_list.stool,LomanNJ_2013_Hi.pathcoverage.stool

will return two files, without clinical / sequencing metadata: 
    * LomanNJ_2013_Hi.metaphlan_bugs_list.stool.tsv providing MetaPhlAn2 taxonomic relative abundances, and
    * LomanNJ_2013_Hi.pathcoverage.stool.tsv providing HUMAnN2 pathway coverages

"

input <- docopt(doc)

required.packages <- c("curatedMetagenomicData", "Biobase")
for (pkg in required.packages){
  if(!suppressPackageStartupMessages(require(pkg, character.only=TRUE))){
    stop(paste0("Make sure Bioconductor is installed (www.bioconductor.org/install), then type:\n
                BiocInstaller::biocLite(\"", pkg, "\") \n
                from your R prompt."))
  }
}


requested.datasets <- strsplit(input$dataset, ",")[[1]]
all.datasets <- ls("package:curatedMetagenomicData")
all.datasets <-  grep("marker|gene|path|metaphlan_bugs", all.datasets, val=TRUE)

if(!all(requested.datasets %in% all.datasets))
  stop("--dataset argument is not an available dataset")

for (i in seq_along(requested.datasets)){
  message(paste0("Working on ", requested.datasets[i]))
  eset <- do.call(get(requested.datasets[i]), list())
  if(input$counts){
    edat <- round(sweep(exprs(eset), 2, eset$number_reads, "*"))
  }else{
    edat <- exprs(eset)
  }
  if(input$pdata){
    pdat <- t(as.matrix(pData(eset)))
    edat <- rbind(pdat, edat)
  }
  write.table(edat, file = paste0(requested.datasets[i], ".tsv"), quote = FALSE)
}